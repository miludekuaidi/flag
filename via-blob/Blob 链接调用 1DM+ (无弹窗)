// ==UserScript==
// @name         Blob 链接调用 1DM+ (无弹窗)
// @namespace    via
// @version      1.1
// @description  点击 blob 链接时，提取真实请求并交给 1DM+ 下载（无弹窗）
// @match        *://*/*
// @grant        none
// ==/UserScript==

(function() {
    let lastRealUrl = null;

    // 记录 fetch 请求
    const origFetch = window.fetch;
    window.fetch = function() {
        let url = arguments[0];
        if (typeof url === "string" && url.startsWith("http")) {
            lastRealUrl = url;
            console.log("捕获 fetch 请求:", url);
        }
        return origFetch.apply(this, arguments);
    };

    // 记录 XHR 请求
    const origOpen = XMLHttpRequest.prototype.open;
    XMLHttpRequest.prototype.open = function(method, url) {
        if (typeof url === "string" && url.startsWith("http")) {
            lastRealUrl = url;
            console.log("捕获 XHR 请求:", url);
        }
        return origOpen.apply(this, arguments);
    };

    // 点击事件拦截
    document.addEventListener("click", function(e) {
        let target = e.target;

        while (target && !target.href) {
            target = target.parentElement;
        }

        if (target && target.href && target.href.startsWith("blob:")) {
            e.preventDefault();
            if (lastRealUrl) {
                // 调用 1DM+ (包名 idm.internet.download.manager.plus)
                let intentUrl = "intent:" + lastRealUrl + "#Intent;package=idm.internet.download.manager.plus;end";
                window.location.href = intentUrl;
            }
        }
    }, true);
})();
