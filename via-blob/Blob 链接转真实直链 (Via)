// ==UserScript==
// @name         Blob 链接转真实直链 (Via)
// @namespace    via
// @version      1.2
// @description  点击 blob 链接时，替换为真实请求直链，交给浏览器自带下载器（可配合 IDM+）
// @match        *://*/*
// @grant        none
// ==/UserScript==

(function() {
    let lastRealUrl = null;

    // 记录 fetch 请求
    const origFetch = window.fetch;
    window.fetch = function() {
        let url = arguments[0];
        if (typeof url === "string" && url.startsWith("http")) {
            lastRealUrl = url;
            console.log("捕获 fetch 请求:", url);
        }
        return origFetch.apply(this, arguments);
    };

    // 记录 XHR 请求
    const origOpen = XMLHttpRequest.prototype.open;
    XMLHttpRequest.prototype.open = function(method, url) {
        if (typeof url === "string" && url.startsWith("http")) {
            lastRealUrl = url;
            console.log("捕获 XHR 请求:", url);
        }
        return origOpen.apply(this, arguments);
    };

    // 点击事件拦截
    document.addEventListener("click", function(e) {
        let target = e.target;

        while (target && !target.href) {
            target = target.parentElement;
        }

        if (target && target.href && target.href.startsWith("blob:")) {
            e.preventDefault();
            if (lastRealUrl) {
                // 替换为真实直链，交给浏览器自身处理
                window.location.href = lastRealUrl;
            }
        }
    }, true);
})();
